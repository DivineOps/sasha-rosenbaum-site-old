<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Prompt for Sign-In on 401 – Unauthorized Errors in MVC App with Azure Active Directory Using WS Federation</title>

  <meta name="description" content="Prompt for Sign-In on 401 – Unauthorized Errors in MVC App with Azure Active Directory Using WS Federation"/>
  <meta name="author" content="Sasha Rosenbaum"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <base href="/" />

  <link rel="icon" type="image/png" href="media/favicon.png"  /> 

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-115911216-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <script type="text/javascript">  var appInsights=window.appInsights||function(a){    function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c    }({        instrumentationKey:"36613b8d-5a20-4544-b70b-99056ca43b92"    });      window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView();</script>

  <link rel="stylesheet" href="css/fonts.css"/>
  <link rel="stylesheet" href="css/normalize.css"/>
  <link rel="stylesheet" href="css/skeleton.css"/>
  <link rel="stylesheet" href="css/custom.css"/>
  <link rel="stylesheet" href="genericons/genericons.css"/>
  
  
    
  
  <link rel="stylesheet" href="highlight/tomorrow-night.css"/>

  <link href="index.xml" rel="alternate" type="application/rss+xml" title="Posts + Links" />
  <link href="links/index.xml" rel="alternate" type="application/rss+xml" title="Links" />
  <link href="posts/index.xml" rel="alternate" type="application/rss+xml" title="Posts" />

  
</head>
<body>

<div id="flex-container">
  <input type="checkbox" id="sidebar-menu-checkbox" />
  <label for="sidebar-menu-checkbox" id="sidebar-menu"></label>

  <div id="fake-sidebar"></div>
  <div id="container">


<div id="post-header">
  <p class="post-infos">
    <time>2012-03-10 00:00</time>
    

  </p>
  <h1>Prompt for Sign-In on 401 – Unauthorized Errors in MVC App with Azure Active Directory Using WS Federation</h1>
</div>



<div class="post">
  

<p>Following my post on Partial Authentication with AAD I am going to elaborate on how to prompt the user to sign into the application instead of throwing a 401 – unauthorized error.</p>

<p>First step is to add HTTP error 401 redirect to IIS configuration in Web.config</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;system.webServer&gt;</span>
    <span style="color:#f92672">&lt;httpErrors</span> <span style="color:#a6e22e">existingResponse=</span><span style="color:#e6db74">&#34;Replace&#34;</span> 
			<span style="color:#a6e22e">defaultResponseMode=</span><span style="color:#e6db74">&#34;Redirect&#34;</span> <span style="color:#a6e22e">errorMode=</span><span style="color:#e6db74">&#34;Custom&#34;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;remove</span> <span style="color:#a6e22e">statusCode=</span><span style="color:#e6db74">&#34;401&#34;</span><span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;error</span> <span style="color:#a6e22e">statusCode=</span><span style="color:#e6db74">&#34;401&#34;</span> <span style="color:#a6e22e">responseMode=</span><span style="color:#e6db74">&#34;ExecuteURL&#34;</span> <span style="color:#a6e22e">path=</span><span style="color:#e6db74">&#34;/Account/SignInRedirect&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/httpErrors&gt;</span>
	...
<span style="color:#f92672">&lt;system.webServer&gt;</span></code></pre></div>

<p>Note that the responseMode is ExecuteURL (and not Redirect). This allows the requested URL to be passed through to the SignInRedirect method.</p>

<p>Now all we need is to add proper redirect conditions to our /Account/SignInRedirect method</p>

<!-- readmore -->

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> ActionResult SignInRedirect()
{
	<span style="color:#66d9ef">if</span> (Request.IsAuthenticated)
	{
		<span style="color:#75715e">// The user is signed in 
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// but does not have permissions to access a specific URL
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> RedirectToAction(<span style="color:#e6db74">&#34;InsufficientPermissions&#34;</span>, <span style="color:#e6db74">&#34;Account&#34;</span>);
	}

	<span style="color:#75715e">// Redirect to home page after signing in.	
</span><span style="color:#75715e"></span>	WsFederationConfiguration config = 
		FederatedAuthentication.FederationConfiguration.WsFederationConfiguration;
		
	<span style="color:#66d9ef">string</span> callbackUrl = Url.Action(<span style="color:#e6db74">&#34;Index&#34;</span>, <span style="color:#e6db74">&#34;Home&#34;</span>, 
			routeValues: <span style="color:#66d9ef">null</span>, protocol: Request.Url.Scheme);
	
	<span style="color:#75715e">//The URL the user originally requested is passed in Request.RawUrl
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (Request.RawUrl != <span style="color:#66d9ef">null</span>)
	{
		callbackUrl = Request.RawUrl;
	}

	SignInRequestMessage signInRequest = 
		FederatedAuthentication.WSFederationAuthenticationModule
		.CreateSignInRequest(
			uniqueId: String.Empty,
			returnUrl: callbackUrl,
			rememberMeSet: <span style="color:#66d9ef">false</span>);

	signInRequest.SetParameter(<span style="color:#e6db74">&#34;wtrealm&#34;</span>, IdentityConfig.Realm ?? config.Realm);
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RedirectResult(signInRequest.RequestUrl.ToString());
}
</code></pre></div>

<p>There are 2 main use cases this method aims to cover:</p>

<h3 id="a-non-authenticated-user-gets-tries-to-access-a-url-that-requires-authorization">A non-authenticated user gets tries to access a URL that requires authorization</h3>

<p>When a non-authenticated user tries to access a URL that is behind an [Authorize] attribute she will get a 401 – Unauthorized error. This error will be redirected by IIS to the path specified in httpErrors configuration, in our case /Account/SignInRedirect. The original URL will be passed on as well in Request.RawUrl. The sign in method will then attempt to sign the user in, and if the sign in is successful redirect her to the originally requested URL.</p>

<h3 id="an-authenticated-user-tries-to-access-a-url-he-does-not-have-access-to">An authenticated user tries to access a URL he does not have access to</h3>

<p>In this case the first if clause of the sign in method will be activated, and the user will be redirected to a custom error page. You can inform the user that she does not have permissions to view the page, or craft any other custom error message. You could also choose to redirect the user back to home page. The one thing you should <em>not</em> do is redirecting the user back to the Request.RawUrl, as this will result in an infinite redirect loop.
Another possible behavior in this case would be to prompt the user to sign in with an account that does have access to the requested URL. This behavior is, however, not typical for AD scenarios, where it is unlikely that a single user has access to multiple AD accounts.</p>

<p>Why am I separating the /Account/SignInRedirect from the regular /Account/SignIn method?
The reason is the case when the user tries to sign in via /Account/SignIn, and her credentials are already stored by the browser. In this case the user should be redirected to home, rather than hitting the insufficient permissions error page. Please view the original post for the /Account/SignIn method implementation.</p>

</div>



<footer>
  <p class="footnote">Copyright &copy; 2019: All rights reserved by <a href="mailto:divineops@outlook.com">Sasha Rosenbaum</a></p>
</footer>

  </div>
  <div id="container-mask"></div>
<div id="sidebar">
<div class="sidebar">
  <div class="sidebar-about">
    <a href="/">
      <img src="media/me.jpg" title="Sasha Rosenbaum" alt="Me" />
      <h4 class="sidebar-title">Sasha Rosenbaum</h4>
    </a>
    <span class="sidebar-tagline"> Azure Global Black Belt @Microsoft </span>
  </div>
  <nav class="sidebar-nav">
    <ul class="sidebar-nav-list">
      <li class="sidebar-nav-item nav-home">
        <span class="genericon genericon-home"></span><a class="sidebar-link" href="/">Home</a>
      </li>
      
    </ul>
  </nav>
  <div class="sidebar-externals">
    
  
    
    <a class="genericon genericon-github" href="https://github.com/DivineOps" ></a>
    
  
    
    | <a class="genericon genericon-twitter" href="https://twitter.com/DivineOps"></a>
    
  
    
  
    
  
    
    | <a class="genericon genericon-linkedin-alt" href="https://www.linkedin.com/in/sasha-rosenbaum"></a>
    
  
    
    | <a class="genericon genericon-mail" href="mailto:divineops@outlook.com"></a>
</div>

<div class="sidebar-bookpromo">
  <a target="_blank"  
  href="https://www.amazon.com/gp/product/1787288390/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1787288390&linkCode=as2&tag=sasharosenbau-20&linkId=a4d91f5aa32acd296a5b6903d9e9ba92">
  <img border="0" 
  src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=US&ASIN=1787288390&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=sasharosenbau-20" ></a><img src="//ir-na.amazon-adsystem.com/e/ir?t=sasharosenbau-20&l=am2&o=1&a=1787288390" 
  width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
</div>

<div class="sidebar-bottom">
  <div class="sidebar-bottom-poweredby">
    <hr />
    <p>Powered by <a href="http://gohugo.io">Hugo</a>.</p> <p>Theme: <a href="https://github.com/TiTi/hurock">Hurock</a>.</p>
    <p>Copyright &copy; 2019.</p> <p>All rights reserved.</p>
  </div>
</div>
</div>
</div>

</div>

<script src="highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Google Analytics Tracking ID', 'auto');
ga('send', 'pageview');
</script>




</body>
</html>

